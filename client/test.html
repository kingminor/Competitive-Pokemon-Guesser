<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ShadowDex Game Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, button { margin: 5px; padding: 5px; }
        #log { margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: #f9f9f9;}
        img { display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ShadowDex Game Test</h1>

    <div>
        <h3>Create Game</h3>
        Nickname: <input type="text" id="createNickname" placeholder="Your nickname"><br>
        Max Players: <input type="number" id="maxPlayers" value="4"><br>
        Time Before Reveal (sec): <input type="number" id="timeBeforeReveal" value="10"><br>
        <button id="createGameBtn">Create Game</button>
    </div>

    <div>
        <h3>Join Game</h3>
        Nickname: <input type="text" id="joinNickname" placeholder="Your nickname"><br>
        Game ID: <input type="text" id="joinGameId" placeholder="Game ID"><br>
        <button id="joinGameBtn">Join Game</button>
    </div>

    <div>
        <h3>Game Actions</h3>
        Player ID: <input type="text" id="playerID" placeholder="Your PlayerID" readonly><br>
        Game ID: <input type="text" id="actionGameID" placeholder="Game ID"><br>
        <button id="startGameBtn">Start Game</button><br>
        Guess Pokemon: <input type="text" id="guessInput" placeholder="Enter Pokemon name">
        <button id="guessBtn">Submit Guess</button>
    </div>

    <div id="log"></div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5070/GameHub")
            .withAutomaticReconnect()
            .build();

        // ðŸ” Wrap connection.on to log ALL received messages
        const originalOn = connection.on.bind(connection);
        connection.on = (eventName, callback) => {
            return originalOn(eventName, (...args) => {
                console.log(`[SignalR] Event: ${eventName}`, args);
                callback(...args);
            });
        };

        const logDiv = document.getElementById("log");
        let playerID = null;

        function log(message) {
            const p = document.createElement("p");
            p.textContent = message;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Server events
        connection.on("Connected", (id) => {
            playerID = id;
            document.getElementById("playerID").value = playerID;
            log(`Connected to server. Your PlayerID: ${playerID}`);
        });

        connection.on("Nickname Changed", () => {
            log("Nickname successfully updated.");
        });

        connection.on("Game Created", (gameID) => {
            log(`Game Created! GameID: ${gameID}`);
            document.getElementById("actionGameID").value = gameID;
        });

        connection.on("Joined Game", () => {
            log("Successfully joined the game.");
        });

        connection.on("Error", (msg) => {
            log(`Error: ${msg || 'Unknown error'}`);
        });

        connection.on("Game Started", (imageUrl) => {
            log(`Game Started! Image to guess:`);
            const img = document.createElement("img");
            img.src = imageUrl;
            img.style.height = "150px";
            logDiv.appendChild(img);
        });

        connection.on("End Game", (reason, winnerPlayerID, pokemonName) => {
            if(reason === "Correct Guess") {
                log(`Player ${winnerPlayerID} guessed correctly! Pokemon was: ${pokemonName}`);
            } else if(reason === "Time Up") {
                log(`Time is up! The Pokemon was: ${pokemonName}`);
            }
        });

        connection.on("Incorrect Guess", () => {
            log("Incorrect guess. Try again!");
        });

        // Optional lifecycle logs
        connection.onreconnecting(err => console.warn("Reconnecting...", err));
        connection.onreconnected(id => console.log("Reconnected. New connectionId:", id));
        connection.onclose(err => console.error("Connection closed.", err));

        connection.start().then(() => {
            log("Connecting to GameHub...");
        }).catch(err => console.error(err.toString()));

        // Button actions
        document.getElementById("createGameBtn").addEventListener("click", async () => {
            const nickname = document.getElementById("createNickname").value;
            const maxPlayers = parseInt(document.getElementById("maxPlayers").value);
            const timeBeforeReveal = parseInt(document.getElementById("timeBeforeReveal").value);

            if(!playerID) { log("Not connected yet."); return; }

            if(nickname) {
                await connection.invoke("EditNickName", playerID, nickname)
                    .catch(err => log(`Error: ${err}`));
            }

            await connection.invoke("CreateGame", maxPlayers, timeBeforeReveal, playerID)
                .catch(err => log(`Error: ${err}`));
        });

        document.getElementById("joinGameBtn").addEventListener("click", async () => {
            const nickname = document.getElementById("joinNickname").value;
            const gameID = document.getElementById("joinGameId").value.toUpperCase();

            if(!playerID) { log("Not connected yet."); return; }

            if(nickname) {
                await connection.invoke("EditNickName", playerID, nickname)
                    .catch(err => log(`Error: ${err}`));
            }

            await connection.invoke("JoinGame", playerID, gameID)
                .catch(err => log(`Error: ${err}`));
        });

        document.getElementById("startGameBtn").addEventListener("click", async () => {
            if(!playerID) { log("Not connected yet."); return; }
            await connection.invoke("StartGame", playerID)
                .catch(err => log(`Error: ${err}`));
        });

        document.getElementById("guessBtn").addEventListener("click", async () => {
            const guess = document.getElementById("guessInput").value;
            if(!playerID) { log("Not connected yet."); return; }
            if(!guess) return;

            log(`You guessed: ${guess}`);
            await connection.invoke("GuessPokemon", playerID, guess)
                .catch(err => log(`Error: ${err}`));
        });
    </script>
</body>
</html>
